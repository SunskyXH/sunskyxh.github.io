<!DOCTYPE html>
<html lang=en,zh-cn,default>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="这里什么都没有">
  <meta name="keywords" content="undefined">
  
    <link rel="icon" href="">
  
  <title>我不懂的js集合</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/atom-one-light.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
  <script src="/js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
  <div class="wrapper">
    <div class="default_title">
        <img src="/imgs/mycomputer.png" />
        <h1>香香鸡的小窝</h1>
    </div>
    <ul class="topbar">
    
        <li>
        <a href="/" class="item-link">首页</a>
        </li>
    
        <li>
        <a href="/about" class="item-link">关于</a>
        </li>
    
    </ul>
    <div class="tag_list">
    <ul id="tag-list">
        <li><a href="/" ><img src="/imgs/disk.png" />(C:)</a>
        <ul>
        
            <li>
            <a href="/tags/GraphQL" title="GraphQL" rel="1">
                <img src="/imgs/folder.ico" />
                GraphQL
            </a>
            </li>    
        
            <li>
            <a href="/tags/Relay" title="Relay" rel="1">
                <img src="/imgs/folder.ico" />
                Relay
            </a>
            </li>    
        
            <li>
            <a href="/tags/Vue" title="Vue" rel="3">
                <img src="/imgs/folder.ico" />
                Vue
            </a>
            </li>    
        
            <li>
            <a href="/tags/javascript" title="javascript" rel="3">
                <img src="/imgs/folder.ico" />
                javascript
            </a>
            </li>    
        
            <li>
            <a href="/tags/Typescript" title="Typescript" rel="1">
                <img src="/imgs/folder.ico" />
                Typescript
            </a>
            </li>    
        
            <li>
            <a href="/tags/redux-saga" title="redux-saga" rel="1">
                <img src="/imgs/folder.ico" />
                redux-saga
            </a>
            </li>    
        
            <li>
            <a href="/tags/redux-observable" title="redux-observable" rel="1">
                <img src="/imgs/folder.ico" />
                redux-observable
            </a>
            </li>    
        
            <li>
            <a href="/tags/React" title="React" rel="1">
                <img src="/imgs/folder.ico" />
                React
            </a>
            </li>    
        
            <li>
            <a href="/tags/Preact" title="Preact" rel="1">
                <img src="/imgs/folder.ico" />
                Preact
            </a>
            </li>    
        
            <li>
            <a href="/tags/Virtual DOM" title="Virtual DOM" rel="1">
                <img src="/imgs/folder.ico" />
                Virtual DOM
            </a>
            </li>    
        
            <li>
            <a href="/tags/Reason" title="Reason" rel="1">
                <img src="/imgs/folder.ico" />
                Reason
            </a>
            </li>    
        
            <li>
            <a href="/tags/OCaml" title="OCaml" rel="1">
                <img src="/imgs/folder.ico" />
                OCaml
            </a>
            </li>    
        
            <li>
            <a href="/tags/bucklescript" title="bucklescript" rel="1">
                <img src="/imgs/folder.ico" />
                bucklescript
            </a>
            </li>    
        
        </ul>
    </ul>
    </div>
    <div class="post_list">
    <ul>
        
            <li>
            <a href="/2017/02/22/GraphQL-Relay-first-explore/">
            <img src="/imgs/file.ico" />
                GraphQL+Relay初探
            </a>
            </li>
        
            <li>
            <a href="/2016/08/20/The-State-of-Vue/">
            <img src="/imgs/file.ico" />
                The State of Vue(自译)
            </a>
            </li>
        
            <li>
            <a href="/2017/04/05/6-reasons-why-javascripts-async-await-blows-promises-away/">
            <img src="/imgs/file.ico" />
                Async/Await胜过Promise的6个理由（自译）
            </a>
            </li>
        
            <li>
            <a href="/2018/03/12/dose-refactoring-vue-project-into-typescript-deserved/">
            <img src="/imgs/file.ico" />
                有必要将Vue项目重构到Typescript吗?
            </a>
            </li>
        
            <li>
            <a href="/2017/03/30/i-dont-know-js/">
            <img src="/imgs/file.ico" />
                我不懂的js集合
            </a>
            </li>
        
            <li>
            <a href="/2016/09/10/vue-directive-to-highlight-code/">
            <img src="/imgs/file.ico" />
                vue自定义指令实现Highlight.js高亮代码
            </a>
            </li>
        
            <li>
            <a href="/2017/02/26/preact-virtual-DOM-algorithm-explore/">
            <img src="/imgs/file.ico" />
                Preact Virtual DOM算法探究
            </a>
            </li>
        
            <li>
            <a href="/2017/12/17/reason-intro/">
            <img src="/imgs/file.ico" />
                Reason简介
            </a>
            </li>
        
    </ul>
    </div>

    <div class="post_total">
        
            <div class="left">8 object(s)</div>
        
        <div class="right">&nbsp;</div>
    </div>
</div>
  <div class="content">
    <div class="post_title">
      <img src="/imgs/file.png" />
      <h1>我不懂的js集合</h1>
      <a href="/"><div class="btn"><span class="fa fa-times"></span></div></a>
      <div class="btn btn_max"><span class="fa fa-window-maximize"></span></div>
      <div class="btn"><span class="fa fa-window-minimize"></span></div>
    </div>
    <ul class="topbar">
      <li>Thu Mar 30 2017 20:57:55 GMT+0800</li>
    </ul>
    <div class="post_content">
      <blockquote>
<p>在公司实习的时候学到了不少新东西，不如简单记录一些</p>
</blockquote>
<h3 id="1-取消异步请求带来的思考"><a href="#1-取消异步请求带来的思考" class="headerlink" title="1 取消异步请求带来的思考"></a>1 取消异步请求带来的思考</h3><p>最近实习的时候遇到了这样的一个需求，发送请求A之后，浏览器还有可能异步发送相同接口的请求A1，由于服务端计算的时间长短可能不一样，导致返回的顺序不一定与请求发送的顺序一致，导致界面显示的数据与最后一次请求所期望的结果不一样。</p>
<ol>
<li>甩锅给服务端<br>让服务端每次返回都带上一个id，通过id去匹配返回的结果是否为最后一次查询所预期的。我想这样能解决问题，但是隐约感觉到能在不修改服务端代码的情况下解决问题，于是就开始瞎折腾。</li>
<li>尝试用debounce<br>最开始没有深入思考这个问题，简单的认为用debounce来保证短时间内多次操作只会发送一次请求。后来发现并不是那么简单，在debounce设置的延迟内服务端可能还没返回结果，若是此时浏览器又发送了新的请求，依然会出现最开始的问题。</li>
<li>发送请求后将对应的界面disable掉<br>可以在发送请求，返回结果之前将对应触发请求的界面给disable掉，但是我想这样有两个缺点：1.对用户不够友好，一个误操作可能就要等到返回结果才能重新操作。2.并不是通用的解决方法，只适用于用户操作触发事件的情况。</li>
<li><p>不知道叫什么的解决方法<br>想了很久以后决定去问问导师，导师告诉我他之前也遇到过这样的问题，给我讲了一下他的大致思路：</p>
<ul>
<li>将原方法外面包装两层，设置一个<code>cancelHandler</code>，初始为null，每次发送请求会返回一个把<code>isCancel</code>变量置为ture的函数，将这个函数赋值给<code>cancelHandler</code>，只要<code>cancelHandler</code>不为null（说明之前发送过请求了），就执行<code>cancelHandler</code>来将<code>isCancel</code>置为ture。之后再执行第二层包装的方法。</li>
<li>第二层方法先创建一个变量<code>isCancel</code>并初始化为false，该变量用于判断是否处理response。然后创建了一个<code>succsessCallback</code>函数，该函数会作为原本发送请求的方法（成功时）的回调函数，判断<code>isCancel</code>的值来决定处不处理response。之后创建了一个<code>cancaelCallback</code>函数作为第二层包装的返回值，也就是之前那一步里赋值给<code>cancelHandler</code>的函数。之后在执行原本的请求，回调调用<code>successCallback</code>函数来判断<code>isCancel</code>以决定是否对<code>response</code>进行处理。最后第二层包装返回<code>cancelCallback</code>函数。</li>
<li>当第一个请求发送之后，第二个请求事件触发时，此时<code>cancelHandler</code>不为null，会去将<code>isCancel</code>置为ture，这样就不会处理第一次请求的response。</li>
<li>前面一大段简单点说就是根据有没有新的请求事件触发来决定是否处理上一次请求的response。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//在一个React组件的内部</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>&#123;</div><div class="line">        <span class="comment">//balabala</span></div><div class="line">        <span class="keyword">this</span>.cancelHandler = <span class="literal">null</span>; <span class="comment">//初始化cancelHandler</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//包在最外层的方法，触发发送请求时，调用此方法</span></div><div class="line">    startFetchData (params) &#123;</div><div class="line">        <span class="keyword">this</span>.cancelHandler &amp;&amp; <span class="keyword">this</span>.cancelHandler();</div><div class="line">        <span class="keyword">this</span>.cancelHandler = <span class="keyword">this</span>.fetchData(params);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//第二层包装,其中realFetchData()是最开始去发送请求的方法</span></div><div class="line">    fetchData (params) &#123;</div><div class="line">        <span class="keyword">let</span> isCancel = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">let</span> successCallback = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">if</span>(isCancel) <span class="keyword">return</span>;</div><div class="line">            <span class="comment">//接下来进行原本对response进行的操作</span></div><div class="line">            <span class="comment">//...</span></div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">let</span> cancelCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            isCancel = <span class="literal">true</span>;</div><div class="line">        &#125;;</div><div class="line">        </div><div class="line">        realFetchData(params).then(successCallback);</div><div class="line">        <span class="keyword">return</span> cancelCallback;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//实际会这样调用</span></div><div class="line">    onSomethingClick () &#123;</div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="keyword">this</span>.startFetchData(params);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>于是我很顺利的就解决了这个问题。但是这样还是有着一些缺点和值得思考的点，比如依然会发送一次请求，比如如何进行异常处理最合适，能不能用<code>async/await</code>让代码看起来更简单等等。</p>
</li>
<li><p>redux-sage<br>(偷懒直接拿来官方文档的例子改了改)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; take, put, call, fork, cancel, cancelled &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</div><div class="line"><span class="keyword">import</span> &#123; delay &#125; <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Api <span class="keyword">from</span> <span class="string">'./api'</span>;</div><div class="line"><span class="keyword">import</span> &#123;action&#125; <span class="keyword">from</span> <span class="string">'./action'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bgSync</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> put(actions.requestStart())</div><div class="line">      <span class="keyword">const</span> result = <span class="keyword">yield</span> call(Api.fetchData)</div><div class="line">      <span class="keyword">yield</span> put(actions.requestSuccess(result))</div><div class="line">      <span class="keyword">yield</span> call(delay, <span class="number">5000</span>)</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">yield</span> cancelled())</div><div class="line">      <span class="keyword">yield</span> put(actions.requestFailure(<span class="string">'Sync cancelled!'</span>))</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">main</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">while</span> ( <span class="keyword">yield</span> take(START_BACKGROUND_SYNC) ) &#123;</div><div class="line">    <span class="comment">// starts the task in the background</span></div><div class="line">    <span class="keyword">const</span> bgSyncTask = <span class="keyword">yield</span> fork(bgSync)</div><div class="line"></div><div class="line">    <span class="comment">// wait for the user stop action</span></div><div class="line">    <span class="keyword">yield</span> take(STOP_BACKGROUND_SYNC)</div><div class="line">    <span class="comment">// user clicked stop. cancel the background task</span></div><div class="line">    <span class="comment">// this will cause the forked bgSync task to jump into its finally block</span></div><div class="line">    <span class="keyword">yield</span> cancel(bgSyncTask)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>redux-observable<br>redux-observable的<code>takeUtils()</code>能取消发送的请求，<br>同时能使用<code>rxjs</code>的一些运算符，还能异常处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Api <span class="keyword">from</span> <span class="string">'./api'</span>;<span class="comment">//假设我们的api请求函数返回的都是Promise</span></div><div class="line"><span class="keyword">import</span> <span class="string">'rxjs'</span>;</div><div class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs/Observable'</span>;</div><div class="line"><span class="comment">//Action type</span></div><div class="line"><span class="keyword">const</span> FETCH_DATA = <span class="string">'FETCH_DATA'</span>;</div><div class="line"><span class="keyword">const</span> FETCH_DATA_FULFILLED = <span class="string">'FETCH_DATA_FULFILLED'</span>;</div><div class="line"><span class="keyword">const</span> FETCH_DATA_FAILURE = <span class="string">'FETCH_DATA_FAILURE'</span>;</div><div class="line"><span class="keyword">const</span> FETCH_DATA_CANCELLED = <span class="string">'FETCH_DATA_CANCELLED'</span>;</div><div class="line"></div><div class="line"><span class="comment">//Action creator</span></div><div class="line"><span class="keyword">const</span> fetchData = <span class="function">(<span class="params">params</span>) =&gt;</span> (&#123;<span class="attr">type</span>: FETCH_DATA, <span class="attr">payload</span>: params&#125;);</div><div class="line"><span class="keyword">const</span> fetchDataFullfilled = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: FETCH_DATA_FULFILLED, payload&#125;);</div><div class="line"><span class="keyword">const</span> fetchDataFailure = <span class="function"><span class="params">error</span> =&gt;</span> (&#123;<span class="attr">type</span>: FETCH_DATA_FAILURE， payload: error&#125;);</div><div class="line"><span class="keyword">const</span> cancelFetchData = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;<span class="attr">type</span>: FETCH_DATA_CANCELLED&#125;);</div><div class="line"></div><div class="line"><span class="comment">//Epic</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchDataEpic = <span class="function"><span class="params">action$</span> =&gt;</span></div><div class="line">  action$.ofType(FETCH_DATA)</div><div class="line">    .mergeMap(<span class="function"><span class="params">action</span> =&gt;</span></div><div class="line">      Observable.fromPromise(Api.fetchDataAjax(&#123;...action.payload&#125;))</div><div class="line">        .map(<span class="function"><span class="params">response</span> =&gt;</span> fetchDataFullfilled(response))</div><div class="line">        .takeUntil(action$.ofType(FETCH_DATA_CANCELLED))</div><div class="line">        .catch(<span class="function"><span class="params">error</span> =&gt;</span> Observable.of(fetchDataFailure(error)))</div><div class="line">      );</div></pre></td></tr></table></figure></li>
</ol>

    </div>
</div>
  <footer class="footer">
  <p> powered by hexo</p>
</footer>
<script>
  var max = document.getElementsByClassName("btn")[1];
  var min = document.getElementsByClassName("btn")[2];

  function maximize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if (wid > 900) {
      widf = wid * 0.9;
      post.style.width = widf + "px";

      if (wid < 1400) {
        cont.style.width = "99%";
      } else {
        cont.style.width = "99.4%";
      }
    }
  }

  function minimize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if ( wid > 900 ) {
      post.style.width = "800px";
      cont.style.width = "98.5%";
    }
  }

  max && max.addEventListener('click', maximize, false);
  min && min.addEventListener('click', minimize, false);

</script>
</body>
</html>